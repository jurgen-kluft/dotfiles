#!/bin/sh
#
#  Install the slaughter client:
#
#  wget -O - https://raw.github.com/skx/dotfiles/master/bin/get-slaughter | sh
#
#  Probably me-specific.
#
# Steve
# --
#




#
#  Are we even running on Debian/Debian-like system?
#
if [ ! -x /usr/bin/apt-get ]; then
    echo "This system doesn't look like a Debian-like distribution"
    exit 1
fi
if [ ! -d /etc/apt ]; then
    echo "This system doesn't look like a Debian-like distribution"
    exit 1
fi



#
#  See if we have the apt-signature helper.
#
if [ -x /usr/bin/apt-key ]; then

    #
    #  If we're missing the key ..
    #
    if ( /usr/bin/apt-key list | grep 2048g/0CB6CBA8 >/dev/null 2>/dev/null ) ; then

        #
        #  Download and install it.
        #
        if ( which wget >/dev/null 2>/dev/null ) ; then

            #
            #  Get the key and pipe to add.
            #
            wget http://packages.steve.org.uk/slaughter/apt-key.pub -O-  | /usr/bin/apt-key add -

            #
            #  Now clean any previously downloaded-lists.
            #
            apt-get clean

        else
            #
            #  Error
            #
            echo "wget not installed - failed to install apt-signing key".
            exit 1
        fi
    fi
fi




#
#  The default distribution.
#
distro="squeeze"

#
#  If we have lsb_base then use it to find the real release.
#
if [ -x /usr/bin/lsb_release ]; then
    new=$(lsb_release -c -s)
    if [ ! -z "$new" ] ;then
        distro=$new
    fi
fi



#
#  Install apt
#
if [ ! -e /etc/apt/sources.list.d/slaughter.list ]; then
    cat > /etc/apt/sources.list.d/slaughter.list <<EOF
#
# Slaughter packages for $distro
#
deb-src http://packages.steve.org.uk/slaughter/$distro/ ./
deb     http://packages.steve.org.uk/slaughter/$distro/ ./

EOF
fi



#
#  Make the configuration directory.
#
mkdir -p /etc/slaughter || true



#
#  If we don't have a conf file, create it.
#
if [ ! -e  /etc/slaughter/slaughter.conf ]; then
    cat > /etc/slaughter/slaughter.conf <<EOF
prefix    = rsync://www.steve.org.uk/slaughter
transport = rsync
EOF
fi



#
#  Update the system.
#
apt-get update



#
#  Install the package
#
apt-get install --yes --force-yes slaughter2-client



#
#  All done.
#
exit 0