#!/bin/sh
#
#  Clone my dotfiles into a new host - in an unauthenticated fashion.
#
#    wget https://raw.github.com/skx/dotfiles/master/bin/get-skx-dotfiles
#    sh ./get-skx-dotfiles --force
#
# Steve
# --
#

#
#  The (unauthenticated dotfile location)
#
src=https://github.com/skx/dotfiles.git

#
#  Are we forcing
#
force=""
if [ "$1" = "--force" ]; then
	force="-f"
fi


#
# Ensure we have the git command
#
if ( ! which git >/dev/null 2>/dev/null ); then

    if [ ! -z "$force" ]; then
        apt-get install git-core --yes --force-yes
    else
        echo "'git' doesn't seem to be installed"
        exit 1
    fi
fi



#
# Store beneath ~/git/
#
mkdir -p ~/git || true



#
#  Checkout / update if already present
#
if [ ! -d ~/git/dotfiles.git ]; then
    git clone --bare $src ~/git/dotfiles.git
else
    git --git-dir=$HOME/git/dotfiles.git --work-tree=$HOME/ pull
fi



#
#  Test that no files would be trashed.
#
if ( git --git-dir=$HOME/git/dotfiles.git --work-tree=$HOME/  checkout -b  original_files $force ); then

    #
    # OK if none would be then we'll update
    #
    git --git-dir=$HOME/git/dotfiles.git --work-tree=$HOME/ commit -a  -m 'original files'
    git --git-dir=$HOME/git/dotfiles.git --work-tree=$HOME/ checkout master
    exit 0
else

    #
    # Somethign would get replaced, damn you /etc/skel !
    #
    echo "re-run with --force to overwrite the named files"
    exit 1
fi
